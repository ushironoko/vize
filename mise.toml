[tools]
node = "24.13.0"
pnpm = "10"
rust = "latest"

[env]
_.path = ["~/.cargo/bin"]

# =============================================================================
# Setup
# =============================================================================

[tasks.setup]
description = "Install all dependencies and git hooks"
run = """
pnpm install
cp scripts/pre-commit .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
echo "âœ… Git hooks installed"
"""

# =============================================================================
# Build
# =============================================================================

[tasks.build]
description = "Build all (native + wasm)"
depends = ["build:native", "build:wasm"]

[tasks."build:native"]
alias = "bn"
description = "Build native NAPI bindings"
run = "pnpm -C npm/vize-native build"

[tasks."build:wasm"]
alias = "bw"
description = "Build WASM bindings for vite-plugin (Node.js)"
run = "wasm-pack build crates/vize_vitrine --target nodejs --out-dir ../../npm/vite-plugin-vize/wasm --features wasm --no-default-features"

[tasks."build:wasm-web"]
alias = "bww"
description = "Build WASM bindings for browser (playground)"
run = "wasm-pack build crates/vize_vitrine --target web --out-dir ../../playground/src/wasm --features wasm --no-default-features"

[tasks."build:vite-plugin"]
alias = "bv"
description = "Build vite-plugin-vize"
depends = ["build:wasm"]
run = "pnpm -C npm/vite-plugin-vize build"

[tasks."build:cli"]
alias = "bc"
description = "Build CLI binary (vize)"
run = "cargo build --release -p vize"

# =============================================================================
# CLI (vize - Vue Compiler)
# =============================================================================
# High-performance Vue SFC compiler with glob pattern matching
# Usage: vize <PATTERNS> [OPTIONS]
#
# OPTIONS:
#   -o, --output <PATH>         Output directory (stdout if not specified)
#   -f, --format <FORMAT>       Output format: js (default), json, stats
#   --ssr                       Enable SSR mode
#   -j, --threads <N>           Number of threads (default: num CPUs)
#   -v, --verbose               Show verbose output
#   --continue-on-error         Continue compilation even on errors

[tasks.cli]
description = "Install vize CLI to cargo bin (accessible from PATH)"
run = "cargo install --path crates/vize --force"

[tasks."cli:help"]
description = "Show vize CLI help"
run = "vize --help"

[tasks."cli:example"]
description = "Example: Compile all .vue files recursively with stats summary"
run = "vize './**/*.vue' -o . -v"

[tasks."cli:example-json"]
description = "Example: Compile .vue files to JSON with summary stats"
run = "vize './**/*.vue' -o . -f json -v"

[tasks."cli:example-ssr"]
description = "Example: Compile .vue files in SSR mode as JSON with stats"
run = "vize './**/*.vue' -o . -f json --ssr -v"

[tasks."cli:example-stats"]
description = "Example: Show only compilation stats (no output files)"
run = "vize './**/*.vue' -f stats -v"

# =============================================================================
# Test
# =============================================================================

[tasks.test]
alias = "t"
description = "Run all Rust tests"
run = "cargo test --workspace"

[tasks."test:vue"]
alias = "tv"
description = "Run Vue compatibility tests"
run = "cargo test -p vize_test_runner"

[tasks.coverage]
alias = "cov"
description = "Show test coverage report"
run = "cargo run -p vize_test_runner --bin coverage"

[tasks."expected:generate"]
alias = "egen"
description = "Generate expected outputs from Vue's official compiler"
run = "node --experimental-strip-types scripts/generate-expected.ts"

[tasks."expected:generate:sfc"]
alias = "egens"
description = "Generate expected outputs for SFC tests"
run = "node --experimental-strip-types scripts/generate-expected.ts sfc/basic sfc/script-setup"

# =============================================================================
# Snapshot Management (TS/JSX/TSX outputs)
# =============================================================================

[tasks.snapshot]
alias = "snap"
description = "Run snapshot tests and review changes"
run = "cargo insta test -p vize_atelier_sfc -- snapshot_tests && cargo insta review"

[tasks."snapshot:test"]
alias = "snapt"
description = "Run snapshot tests only"
run = "cargo insta test -p vize_atelier_sfc -- snapshot_tests"

[tasks."snapshot:review"]
alias = "snapr"
description = "Review pending snapshot changes"
run = "cargo insta review"

[tasks."snapshot:accept"]
alias = "snapa"
description = "Accept all pending snapshot changes"
run = "cargo insta accept"

[tasks."coverage:verbose"]
alias = "covv"
description = "Show coverage with failing test names"
run = "cargo run -p vize_test_runner --bin coverage -- -v"

[tasks."coverage:diff"]
alias = "covd"
description = "Show coverage with diffs"
run = "cargo run -p vize_test_runner --bin coverage -- -vv"

# =============================================================================
# Benchmark
# =============================================================================

[tasks.bench]
alias = "b"
description = "Run SFC compile benchmark (run 'mise run build:native' and 'mise run bench:generate' first if needed)"
run = "node --experimental-strip-types bench/run.ts"

[tasks."bench:quick"]
alias = "bq"
description = "Quick benchmark with 1,000 files (single-thread only)"
run = "node --experimental-strip-types bench/run.ts 1000"

[tasks."bench:generate"]
alias = "bg"
description = "Generate 15,000 SFC files for benchmarking"
run = "node bench/generate.mjs 15000"

[tasks."bench:rust"]
alias = "br"
description = "Run Rust benchmarks (criterion)"
run = "cargo bench -p vize_atelier_sfc"

# =============================================================================
# Development
# =============================================================================

[tasks.dev]
alias = "d"
description = "Start playground dev server (using Vize compiler)"
depends = ["build:vite-plugin", "build:wasm-web"]
run = "CI=true pnpm -C playground dev"

[tasks.example]
alias = "e"
description = "Start vite-plugin-vize example dev server"
depends = ["build:vite-plugin"]
run = "pnpm -C npm/vite-plugin-vize/example dev"

[tasks.check]
alias = "c"
description = "Run cargo check"
run = "cargo check --workspace"

[tasks.clippy]
alias = "cl"
description = "Run clippy lints"
run = "cargo clippy --workspace -- -D warnings"

[tasks.fmt]
alias = "f"
description = "Format Rust code"
run = "cargo fmt --all"

# =============================================================================
# CI / All checks
# =============================================================================

[tasks.ci]
description = "Run all CI checks (fmt, clippy, test)"
depends = ["fmt", "clippy", "test"]

# =============================================================================
# Release
# =============================================================================

[tasks.release]
alias = "r"
description = "Release new version (mise run release <alpha|patch|minor|major|beta|rc|stable>)"
run = "./scripts/release.sh {{arg(name='type', help='Version type: alpha|patch|minor|major|beta|rc|stable')}}"

# =============================================================================
# Publish (Local)
# =============================================================================

[tasks."publish:wasm"]
alias = "pw"
description = "Build and publish @vizejs/wasm to npm"
run = """
cd npm/vize-wasm
cargo build --release -p vize_vitrine --no-default-features --features wasm --target wasm32-unknown-unknown
wasm-bindgen ../../target/wasm32-unknown-unknown/release/vize_vitrine.wasm --out-dir . --target web
VERSION=$(node -p "require('./package.json').version")
if [[ "$VERSION" == *-alpha* ]]; then
  npm publish --access public --tag alpha
elif [[ "$VERSION" == *-beta* ]]; then
  npm publish --access public --tag beta
elif [[ "$VERSION" == *-rc* ]]; then
  npm publish --access public --tag rc
else
  npm publish --access public
fi
"""

[tasks."publish:native"]
alias = "pn"
description = "Build and publish @vizejs/native to npm (current platform only)"
run = """
cd npm/vize-native
pnpm build
VERSION=$(node -p "require('./package.json').version")
if [[ "$VERSION" == *-alpha* ]]; then
  npm publish --access public --tag alpha
elif [[ "$VERSION" == *-beta* ]]; then
  npm publish --access public --tag beta
elif [[ "$VERSION" == *-rc* ]]; then
  npm publish --access public --tag rc
else
  npm publish --access public
fi
"""

[tasks."publish:vite-plugin"]
alias = "pv"
description = "Build and publish @vizejs/vite-plugin to npm"
run = """
cd npm/vite-plugin-vize
pnpm build
VERSION=$(node -p "require('./package.json').version")
if [[ "$VERSION" == *-alpha* ]]; then
  pnpm publish --access public --tag alpha --no-git-checks
elif [[ "$VERSION" == *-beta* ]]; then
  pnpm publish --access public --tag beta --no-git-checks
elif [[ "$VERSION" == *-rc* ]]; then
  pnpm publish --access public --tag rc --no-git-checks
else
  pnpm publish --access public --no-git-checks
fi
"""

[tasks."publish:npm"]
alias = "pnpm"
description = "Publish all npm packages"
depends = ["publish:wasm", "publish:native", "publish:vite-plugin"]

[tasks."publish:crates"]
alias = "pc"
description = "Publish all crates to crates.io (in dependency order)"
run = """
echo "Publishing vize_carton..." && cargo publish -p vize_carton && sleep 30
echo "Publishing vize_relief..." && cargo publish -p vize_relief && sleep 30
echo "Publishing vize_armature..." && cargo publish -p vize_armature && sleep 30
echo "Publishing vize_atelier_core..." && cargo publish -p vize_atelier_core && sleep 30
echo "Publishing vize_atelier_dom..." && cargo publish -p vize_atelier_dom && sleep 30
echo "Publishing vize_atelier_vapor..." && cargo publish -p vize_atelier_vapor && sleep 30
echo "Publishing vize_atelier_sfc..." && cargo publish -p vize_atelier_sfc && sleep 30
echo "Publishing vize_glyph..." && cargo publish -p vize_glyph && sleep 30
echo "Publishing vize_patina..." && cargo publish -p vize_patina && sleep 30
echo "Publishing vize_canon..." && cargo publish -p vize_canon && sleep 30
echo "Publishing vize_musea..." && cargo publish -p vize_musea && sleep 30
echo "Publishing vize_maestro..." && cargo publish -p vize_maestro && sleep 30
echo "Publishing vize_vitrine..." && cargo publish -p vize_vitrine && sleep 30
echo "Publishing vize..." && cargo publish -p vize
echo "Done!"
"""

[tasks.publish]
alias = "p"
description = "Publish all packages (npm + crates.io)"
depends = ["publish:npm", "publish:crates"]
