[tools]
node = "24"
rust = "latest"

# =============================================================================
# Setup
# =============================================================================

[tasks.setup]
description = "Install all dependencies and git hooks"
run = """
pnpm install
cp scripts/pre-commit .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
echo "âœ… Git hooks installed"
"""

# =============================================================================
# Build
# =============================================================================

[tasks.build]
description = "Build all (native + wasm)"
depends = ["build:native", "build:wasm"]

[tasks."build:native"]
alias = "bn"
description = "Build native NAPI bindings"
run = "pnpm -C packages/vue-compiler-rs-native build"

[tasks."build:wasm"]
alias = "bw"
description = "Build WASM bindings for vite-plugin (Node.js)"
run = "wasm-pack build crates/vue_bindings --target nodejs --out-dir ../../packages/vite-plugin-vue-compiler-rs/wasm --features wasm --no-default-features"

[tasks."build:wasm-web"]
alias = "bww"
description = "Build WASM bindings for browser (playground)"
run = "wasm-pack build crates/vue_bindings --target web --out-dir ../../playground/src/wasm --features wasm --no-default-features"

[tasks."build:vite-plugin"]
alias = "bv"
description = "Build vite-plugin-vue-compiler-rs"
depends = ["build:wasm"]
run = "pnpm -C packages/vite-plugin-vue-compiler-rs build"

[tasks."build:cli"]
alias = "bc"
description = "Build CLI binary (vue-compiler)"
run = "cargo build --release -p vue_compiler_cli"

# =============================================================================
# CLI (vuec - Vue Compiler)
# =============================================================================
# High-performance Vue SFC compiler with glob pattern matching
# Usage: vuec <PATTERNS> [OPTIONS]
#
# OPTIONS:
#   -o, --output <PATH>         Output directory (stdout if not specified)
#   -f, --format <FORMAT>       Output format: js (default), json, stats
#   --ssr                       Enable SSR mode
#   -j, --threads <N>           Number of threads (default: num CPUs)
#   -v, --verbose               Show verbose output
#   --continue-on-error         Continue compilation even on errors

[tasks.cli]
description = "Install vuec (Vue Compiler) CLI to cargo bin (accessible from PATH)"
run = "cargo install --path crates/vue_compiler_cli --force"

[tasks."cli:help"]
description = "Show vuec CLI help"
run = "vuec --help"

[tasks."cli:example"]
description = "Example: Compile all .vue files recursively with stats summary"
run = "vuec './**/*.vue' -o . -v"

[tasks."cli:example-json"]
description = "Example: Compile .vue files to JSON with summary stats"
run = "vuec './**/*.vue' -o . -f json -v"

[tasks."cli:example-ssr"]
description = "Example: Compile .vue files in SSR mode as JSON with stats"
run = "vuec './**/*.vue' -o . -f json --ssr -v"

[tasks."cli:example-stats"]
description = "Example: Show only compilation stats (no output files)"
run = "vuec './**/*.vue' -f stats -v"

# =============================================================================
# Test
# =============================================================================

[tasks.test]
alias = "t"
description = "Run all Rust tests"
run = "cargo test --workspace"

[tasks."test:vue"]
alias = "tv"
description = "Run Vue compatibility tests"
run = "cargo test -p vue_test_runner"

[tasks.coverage]
alias = "cov"
description = "Show test coverage report"
run = "cargo run -p vue_test_runner --bin coverage"

[tasks."expected:generate"]
alias = "egen"
description = "Generate expected outputs from Vue's official compiler"
run = "node --experimental-strip-types scripts/generate-expected.ts"

[tasks."expected:generate:sfc"]
alias = "egens"
description = "Generate expected outputs for SFC tests"
run = "node --experimental-strip-types scripts/generate-expected.ts sfc/basic sfc/script-setup"

# =============================================================================
# Snapshot Management (TS/JSX/TSX outputs)
# =============================================================================

[tasks.snapshot]
alias = "snap"
description = "Run snapshot tests and review changes"
run = "cargo insta test -p vue_compiler_sfc -- snapshot_tests && cargo insta review"

[tasks."snapshot:test"]
alias = "snapt"
description = "Run snapshot tests only"
run = "cargo insta test -p vue_compiler_sfc -- snapshot_tests"

[tasks."snapshot:review"]
alias = "snapr"
description = "Review pending snapshot changes"
run = "cargo insta review"

[tasks."snapshot:accept"]
alias = "snapa"
description = "Accept all pending snapshot changes"
run = "cargo insta accept"

[tasks."coverage:verbose"]
alias = "covv"
description = "Show coverage with failing test names"
run = "cargo run -p vue_test_runner --bin coverage -- -v"

[tasks."coverage:diff"]
alias = "covd"
description = "Show coverage with diffs"
run = "cargo run -p vue_test_runner --bin coverage -- -vv"

# =============================================================================
# Benchmark
# =============================================================================

[tasks.bench]
alias = "b"
description = "Run SFC compile benchmark (run 'mise run build:native' and 'mise run bench:generate' first if needed)"
run = "node --experimental-strip-types bench/run.ts"

[tasks."bench:quick"]
alias = "bq"
description = "Quick benchmark with 1,000 files (single-thread only)"
run = "node --experimental-strip-types bench/run.ts 1000"

[tasks."bench:generate"]
alias = "bg"
description = "Generate 15,000 SFC files for benchmarking"
run = "node bench/generate.mjs 15000"

[tasks."bench:rust"]
alias = "br"
description = "Run Rust benchmarks (criterion)"
run = "cargo bench -p vue_compiler_sfc"

# =============================================================================
# Development
# =============================================================================

[tasks.dev]
alias = "d"
description = "Start playground dev server (using official Vue compiler)"
depends = ["build:vite-plugin"]
run = "CI=true pnpm -C playground dev"

[tasks.check]
alias = "c"
description = "Run cargo check"
run = "cargo check --workspace"

[tasks.clippy]
alias = "cl"
description = "Run clippy lints"
run = "cargo clippy --workspace -- -D warnings"

[tasks.fmt]
alias = "f"
description = "Format Rust code"
run = "cargo fmt --all"

# =============================================================================
# CI / All checks
# =============================================================================

[tasks.ci]
description = "Run all CI checks (fmt, clippy, test)"
depends = ["fmt", "clippy", "test"]
