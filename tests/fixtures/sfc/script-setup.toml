# SFC tests: <script setup> compilation
# Based on Vue.js core compiler-sfc/__tests__/compileScript.spec.ts

mode = "sfc"

# =============================================================================
# Basic script setup
# =============================================================================

[[cases]]
name = "basic script setup"
input = """
<script setup>
const msg = 'hello'
</script>

<template>
  <div>{{ msg }}</div>
</template>
"""

[[cases]]
name = "script setup with imports"
input = """
<script setup>
import { ref } from 'vue'
const count = ref(0)
</script>

<template>
  <div>{{ count }}</div>
</template>
"""

[[cases]]
name = "multiple variable declarations"
input = """
<script setup>
const a = 1
let b = 2
var c = 3
</script>

<template>
  <div>{{ a }} {{ b }} {{ c }}</div>
</template>
"""

[[cases]]
name = "function declarations"
input = """
<script setup>
function increment() {
  count++
}
const handler = () => {}
</script>

<template>
  <button @click="increment">Click</button>
</template>
"""

[[cases]]
name = "class declarations"
input = """
<script setup>
class Foo {
  bar = 1
}
</script>

<template>
  <div>{{ Foo }}</div>
</template>
"""

# =============================================================================
# defineProps
# =============================================================================

[[cases]]
name = "defineProps array syntax"
input = """
<script setup>
const props = defineProps(['msg', 'count'])
</script>

<template>
  <div>{{ props.msg }}</div>
</template>
"""

[[cases]]
name = "defineProps object syntax"
input = """
<script setup>
const props = defineProps({
  msg: String,
  count: { type: Number, default: 0 }
})
</script>

<template>
  <div>{{ props.msg }}</div>
</template>
"""

[[cases]]
name = "defineProps without assignment"
input = """
<script setup>
defineProps(['msg'])
</script>

<template>
  <div>{{ msg }}</div>
</template>
"""

[[cases]]
name = "defineProps with destructure"
input = """
<script setup>
const { msg, count = 0 } = defineProps(['msg', 'count'])
</script>

<template>
  <div>{{ msg }} {{ count }}</div>
</template>
"""

# =============================================================================
# defineEmits
# =============================================================================

[[cases]]
name = "defineEmits array syntax"
input = """
<script setup>
const emit = defineEmits(['update', 'change'])
function onClick() {
  emit('update', 1)
}
</script>

<template>
  <button @click="onClick">Click</button>
</template>
"""

[[cases]]
name = "defineEmits without assignment"
input = """
<script setup>
defineEmits(['update'])
</script>

<template>
  <button @click="$emit('update')">Click</button>
</template>
"""

# =============================================================================
# defineModel
# =============================================================================

[[cases]]
name = "defineModel basic"
input = """
<script setup>
const model = defineModel()
</script>

<template>
  <input v-model="model">
</template>
"""

[[cases]]
name = "defineModel with name"
input = """
<script setup>
const title = defineModel('title')
</script>

<template>
  <input v-model="title">
</template>
"""

[[cases]]
name = "defineModel with options"
input = """
<script setup>
const count = defineModel({ type: Number, default: 0 })
</script>

<template>
  <input v-model="count" type="number">
</template>
"""

# =============================================================================
# defineExpose
# =============================================================================

[[cases]]
name = "defineExpose"
input = """
<script setup>
import { ref } from 'vue'
const count = ref(0)
const increment = () => count.value++
defineExpose({ count, increment })
</script>

<template>
  <div>{{ count }}</div>
</template>
"""

# =============================================================================
# defineOptions
# =============================================================================

[[cases]]
name = "defineOptions"
input = """
<script setup>
defineOptions({
  name: 'MyComponent',
  inheritAttrs: false
})
</script>

<template>
  <div>Component</div>
</template>
"""

# =============================================================================
# defineSlots
# =============================================================================

[[cases]]
name = "defineSlots"
input = """
<script setup>
const slots = defineSlots()
</script>

<template>
  <slot></slot>
</template>
"""

# =============================================================================
# Script and script setup co-usage
# =============================================================================

[[cases]]
name = "script before script setup"
input = """
<script>
export const n = 1
export default {}
</script>

<script setup>
import { ref } from 'vue'
const count = ref(0)
</script>

<template>
  <div>{{ count }} {{ n }}</div>
</template>
"""

[[cases]]
name = "script setup before script"
input = """
<script setup>
import { ref } from 'vue'
const count = ref(0)
</script>

<script>
export const n = 1
export default {}
</script>

<template>
  <div>{{ count }} {{ n }}</div>
</template>
"""

[[cases]]
name = "script with type definitions and script setup"
input = """
<script lang="ts">
import type { RouteLocation } from "vue-router";

interface TabItem {
  name: string;
  label: string;
}

export type { TabItem };
</script>

<script setup lang="ts">
const { items } = defineProps<{
  items: Array<TabItem>;
}>();
</script>

<template>
  <div v-for="item in items" :key="item.name">
    {{ item.label }}
  </div>
</template>
"""

[[cases]]
name = "script with interfaces before script setup"
input = """
<script lang="ts">
export interface User {
  id: number;
  name: string;
}
</script>

<script setup lang="ts">
import { ref } from 'vue'
const user = ref<User | null>(null)
</script>

<template>
  <div v-if="user">{{ user.name }}</div>
</template>
"""

# =============================================================================
# Reactive bindings
# =============================================================================

[[cases]]
name = "ref binding"
input = """
<script setup>
import { ref } from 'vue'
const count = ref(0)
</script>

<template>
  <div>{{ count }}</div>
</template>
"""

[[cases]]
name = "reactive binding"
input = """
<script setup>
import { reactive } from 'vue'
const state = reactive({ count: 0 })
</script>

<template>
  <div>{{ state.count }}</div>
</template>
"""

[[cases]]
name = "computed binding"
input = """
<script setup>
import { ref, computed } from 'vue'
const count = ref(0)
const double = computed(() => count.value * 2)
</script>

<template>
  <div>{{ double }}</div>
</template>
"""

[[cases]]
name = "watch and watchEffect"
input = """
<script setup>
import { ref, watch, watchEffect } from 'vue'
const count = ref(0)
watch(count, (n) => console.log(n))
watchEffect(() => console.log(count.value))
</script>

<template>
  <div>{{ count }}</div>
</template>
"""

# =============================================================================
# Template expressions
# =============================================================================

[[cases]]
name = "template with v-model on ref"
input = """
<script setup>
import { ref } from 'vue'
const msg = ref('')
</script>

<template>
  <input v-model="msg">
</template>
"""

[[cases]]
name = "template with event handler"
input = """
<script setup>
import { ref } from 'vue'
const count = ref(0)
const increment = () => count.value++
</script>

<template>
  <button @click="increment">{{ count }}</button>
</template>
"""

[[cases]]
name = "template with inline handler"
input = """
<script setup>
import { ref } from 'vue'
const count = ref(0)
</script>

<template>
  <button @click="count++">{{ count }}</button>
</template>
"""

# =============================================================================
# Async setup
# =============================================================================

[[cases]]
name = "async script setup"
input = """
<script setup>
const data = await fetch('/api').then(r => r.json())
</script>

<template>
  <div>{{ data }}</div>
</template>
"""

[[cases]]
name = "top-level await"
input = """
<script setup>
import { ref } from 'vue'
const count = ref(0)
await new Promise(r => setTimeout(r, 100))
count.value = 1
</script>

<template>
  <div>{{ count }}</div>
</template>
"""

# =============================================================================
# Props destructure with defaults (Vue 3.4+)
# =============================================================================

[[cases]]
name = "defineProps type-only with destructure defaults"
input = """
<script setup lang="ts">
const { color = "primary", appearance = "filled" } = defineProps<{
  color?: "primary" | "success" | "inactive";
  appearance?: "filled" | "outlined";
}>();
</script>

<template>
  <span :class="[color, appearance]"><slot /></span>
</template>
"""

[[cases]]
name = "defineProps array syntax with destructure defaults"
input = """
<script setup>
const { msg = 'hello', count = 0 } = defineProps(['msg', 'count'])
</script>

<template>
  <div>{{ msg }} {{ count }}</div>
</template>
"""

# =============================================================================
# Multiline const with type annotations
# =============================================================================

[[cases]]
name = "multiline const with type annotation"
input = """
<script setup lang="ts">
interface LayoutConfig {
  name: string;
  columns: number;
}

const defaultLayout: LayoutConfig = {
  name: "default",
  columns: 12,
};

const secondLayout: LayoutConfig = {
  name: "secondary",
  columns: 6,
};
</script>

<template>
  <div>{{ defaultLayout.name }} {{ secondLayout.columns }}</div>
</template>
"""

# =============================================================================
# Generic components (Vue 3.3+)
# =============================================================================

[[cases]]
name = "generic component basic"
input = """
<script setup lang="ts" generic="T">
defineProps<{
  items: T[]
  selected: T
}>()
</script>

<template>
  <div v-for="item in items" :key="String(item)">{{ item }}</div>
</template>
"""

[[cases]]
name = "generic component with extends"
input = """
<script setup lang="ts" generic="T extends string | number">
defineProps<{
  value: T
  options: T[]
}>()
</script>

<template>
  <select>
    <option v-for="opt in options" :key="opt" :value="opt">{{ opt }}</option>
  </select>
</template>
"""

[[cases]]
name = "generic component with multiple type params"
input = """
<script setup lang="ts" generic="T extends object, K extends keyof T">
defineProps<{
  items: T[]
  keyField: K
}>()
</script>

<template>
  <div v-for="item in items" :key="String(item[keyField])">{{ item }}</div>
</template>
"""

[[cases]]
name = "generic component with complex constraint"
input = """
<script setup lang="ts" generic="FormShape extends object">
import { ref } from 'vue'

defineProps<{
  initialState: FormShape
  onSubmit: (data: FormShape) => void
}>()

const formData = ref<FormShape | null>(null)
</script>

<template>
  <form @submit.prevent>
    <slot :data="formData" />
  </form>
</template>
"""

[[cases]]
name = "generic component with default type"
input = """
<script setup lang="ts" generic="T = string">
defineProps<{
  value: T
}>()
</script>

<template>
  <div>{{ value }}</div>
</template>
"""

# =============================================================================
# Complex TypeScript types in props
# =============================================================================

[[cases]]
name = "props with nested object types"
input = """
<script setup lang="ts">
defineProps<{
  config: {
    state: string
    disabled: boolean
    onSuccess?: () => void
  }
}>()
</script>

<template>
  <div>{{ config.state }}</div>
</template>
"""

[[cases]]
name = "props with arrow function types"
input = """
<script setup lang="ts">
defineProps<{
  onSuccess: () => void
  onError: (error: Error) => void
  transform: (value: string) => number
}>()
</script>

<template>
  <div>Component</div>
</template>
"""

[[cases]]
name = "props with union types"
input = """
<script setup lang="ts">
type ButtonVariant =
  | { type: "link"; href: string }
  | { type: "button"; onClick: () => void }

defineProps<{
  variant: ButtonVariant
}>()
</script>

<template>
  <div>{{ variant.type }}</div>
</template>
"""

[[cases]]
name = "props with intersection types"
input = """
<script setup lang="ts">
interface BaseProps {
  id: string
  name: string
}

interface ExtendedProps {
  extra: boolean
}

defineProps<BaseProps & ExtendedProps>()
</script>

<template>
  <div>{{ id }} {{ name }}</div>
</template>
"""

[[cases]]
name = "props with readonly arrays"
input = """
<script setup lang="ts">
defineProps<{
  options: readonly { value: string | number; label: string }[]
}>()
</script>

<template>
  <select>
    <option v-for="opt in options" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
  </select>
</template>
"""

[[cases]]
name = "props with method signatures in object"
input = """
<script setup lang="ts">
defineProps<{
  context: {
    open(): void
    close(): void
    isOpened: boolean
  }
}>()
</script>

<template>
  <div v-if="context.isOpened">Open</div>
</template>
"""

# =============================================================================
# withDefaults with complex types
# =============================================================================

[[cases]]
name = "withDefaults with optional props"
input = """
<script setup lang="ts">
interface Props {
  msg: string
  count?: number
  disabled?: boolean
}

withDefaults(defineProps<Props>(), {
  count: 0,
  disabled: false
})
</script>

<template>
  <div>{{ msg }}</div>
</template>
"""

[[cases]]
name = "withDefaults with function default"
input = """
<script setup lang="ts">
interface Props {
  items?: string[]
}

withDefaults(defineProps<Props>(), {
  items: () => []
})
</script>

<template>
  <div v-for="item in items" :key="item">{{ item }}</div>
</template>
"""

# =============================================================================
# Multiple top-level await (Vue 3.3+)
# =============================================================================

[[cases]]
name = "multiple top-level await calls"
input = """
<script setup lang="ts">
const user = await fetchUser()
const posts = await fetchPosts(user.id)
</script>

<template>
  <div>{{ user.name }} has {{ posts.length }} posts</div>
</template>
"""

[[cases]]
name = "top-level await with destructuring"
input = """
<script setup lang="ts">
const { data, error } = await useFetch('/api/data')
</script>

<template>
  <div v-if="error">Error: {{ error }}</div>
  <div v-else>{{ data }}</div>
</template>
"""

[[cases]]
name = "top-level await in initialization"
input = """
<script setup lang="ts">
import { ref } from 'vue'

await initializeApp()
const store = useStore()
await store.loadData()

const count = ref(0)
</script>

<template>
  <div>{{ count }}</div>
</template>
"""

# =============================================================================
# defineEmits with typed events
# =============================================================================

[[cases]]
name = "defineEmits with typed function signatures"
input = """
<script setup lang="ts">
const emit = defineEmits<{
  (e: 'update', value: string): void
  (e: 'delete', id: number): void
  (e: 'submit'): void
}>()
</script>

<template>
  <button @click="emit('submit')">Submit</button>
</template>
"""

[[cases]]
name = "defineEmits with Vue 3.3+ shorthand"
input = """
<script setup lang="ts">
const emit = defineEmits<{
  change: [value: string]
  submit: []
  update: [id: number, data: object]
}>()
</script>

<template>
  <button @click="emit('submit')">Submit</button>
</template>
"""

# =============================================================================
# Interface with arrow function callback types
# =============================================================================

[[cases]]
name = "interface with callback function type"
input = """
<script setup lang="ts">
interface Props {
  refreshMethod: (loaded: Function) => Promise<void> | void;
}
const props = defineProps<Props>();
</script>

<template>
  <div @click="props.refreshMethod(() => {})">Refresh</div>
</template>
"""

[[cases]]
name = "interface with async callback"
input = """
<script setup lang="ts">
interface Props {
  onSubmit: (data: FormData) => Promise<void>;
  onError?: (error: Error) => void;
}
defineProps<Props>();
</script>

<template>
  <form>Submit</form>
</template>
"""

# =============================================================================
# as const type assertion
# =============================================================================

[[cases]]
name = "array with as const"
input = """
<script setup lang="ts">
const SORT_TYPES = [
  { text: 'Latest', value: 'DESC' },
  { text: 'Oldest', value: 'ASC' }
] as const;

type SortType = typeof SORT_TYPES[number]['value'];
const sortType = ref<SortType>('DESC');
</script>

<template>
  <div>{{ sortType }}</div>
</template>
"""

# =============================================================================
# Complex real-world patterns from reco_for_teacher
# =============================================================================

[[cases]]
name = "withDefaults with Object type"
input = """
<script setup lang="ts">
interface Props {
  outlined?: boolean;
  disabled?: boolean;
  on?: Object;
  height?: number | string;
  color?: string;
}

withDefaults(defineProps<Props>(), {
  outlined: false,
  disabled: false,
  on: undefined,
  height: '2rem',
  color: 'primary'
});
</script>

<template>
  <button :disabled="disabled">Click</button>
</template>
"""

[[cases]]
name = "computed with route params"
input = """
<script setup lang="ts">
import { computed } from 'vue';
import { useRoute } from 'vue-router';

const route = useRoute();

const studentId = computed(() =>
  route.params.studentId ? parseInt(route.params.studentId) : null
);
</script>

<template>
  <div>{{ studentId }}</div>
</template>
"""

[[cases]]
name = "reco RoundedBtn pattern"
input = """
<script setup lang="ts">
interface Props {
  outlined?: boolean;
  isWide?: boolean;
  mini?: boolean;
  disabled?: boolean;
  on?: Object;
  height?: number | string;
  color?: string;
}

withDefaults(defineProps<Props>(), {
  outlined: false,
  isWide: false,
  isMini: false,
  disabled: false,
  on: undefined,
  height: '2rem',
  color: 'primary'
});
</script>

<template>
  <button :disabled="disabled">
    <slot />
  </button>
</template>
"""

[[cases]]
name = "reco GuidanceProgressLapInputBtn pattern"
input = """
<script setup lang="ts">
import { computed } from 'vue';

interface GuidanceProgressFormInput {
  progressLap: number;
  originalProgressLap: number;
  progressUnit: { value: string };
}

interface Props {
  guidanceProgress: GuidanceProgressFormInput;
  disabled?: boolean;
  readonly?: boolean;
}
const props = defineProps<Props>();

const lapClass = computed(() => `lap-${props.guidanceProgress.progressLap}`);
const isChangedProgressLap = computed(
  () => props.guidanceProgress.progressLap !== props.guidanceProgress.originalProgressLap
);
</script>

<template>
  <button
    :class="[{ disabled }, lapClass]"
    :disabled="disabled"
    @click.prevent
  >
    {{ guidanceProgress.progressUnit.value }}
  </button>
</template>
"""
