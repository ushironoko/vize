#!/bin/bash

set -e

echo "üîç Running pre-commit checks in parallel..."

# Create temp files for results
FMT_RESULT=$(mktemp)
CLIPPY_RESULT=$(mktemp)
TEST_RESULT=$(mktemp)

# Run all checks in parallel
(
    if cargo fmt --all -- --check > /dev/null 2>&1; then
        echo "0" > "$FMT_RESULT"
    else
        echo "1" > "$FMT_RESULT"
    fi
) &
FMT_PID=$!

(
    if cargo clippy --workspace -- -D warnings > /dev/null 2>&1; then
        echo "0" > "$CLIPPY_RESULT"
    else
        echo "1" > "$CLIPPY_RESULT"
    fi
) &
CLIPPY_PID=$!

(
    if cargo test --workspace > /dev/null 2>&1; then
        echo "0" > "$TEST_RESULT"
    else
        echo "1" > "$TEST_RESULT"
    fi
) &
TEST_PID=$!

# Wait for all and collect results
wait $FMT_PID
wait $CLIPPY_PID
wait $TEST_PID

FMT_EXIT=$(cat "$FMT_RESULT")
CLIPPY_EXIT=$(cat "$CLIPPY_RESULT")
TEST_EXIT=$(cat "$TEST_RESULT")

# Cleanup temp files
rm -f "$FMT_RESULT" "$CLIPPY_RESULT" "$TEST_RESULT"

# Report results
FAILED=0

if [ "$FMT_EXIT" = "0" ]; then
    echo "‚úÖ Format OK"
else
    echo "‚ùå Format check failed. Run 'cargo fmt --all' to fix."
    FAILED=1
fi

if [ "$CLIPPY_EXIT" = "0" ]; then
    echo "‚úÖ Clippy OK"
else
    echo "‚ùå Clippy check failed. Run 'cargo clippy --workspace' to see errors."
    FAILED=1
fi

if [ "$TEST_EXIT" = "0" ]; then
    echo "‚úÖ Tests OK"
else
    echo "‚ùå Tests failed. Run 'cargo test --workspace' to see failures."
    FAILED=1
fi

if [ "$FAILED" = "1" ]; then
    echo "üí• Pre-commit checks failed!"
    exit 1
fi

echo "üéâ All pre-commit checks passed!"
