#!/bin/bash

set -e

echo "üîç Running pre-commit checks in parallel..."

# Create temp files for results
FMT_RESULT=$(mktemp)
CLIPPY_RESULT=$(mktemp)
TEST_RESULT=$(mktemp)

# Run all checks in parallel with prefixed output
(
    echo "üìù [fmt] Starting format check..."
    if cargo fmt --all -- --check 2>&1 | sed 's/^/[fmt] /'; then
        echo "0" > "$FMT_RESULT"
        echo "üìù [fmt] Done"
    else
        echo "1" > "$FMT_RESULT"
        echo "üìù [fmt] Failed"
    fi
) &
FMT_PID=$!

(
    echo "üìé [clippy] Starting clippy check..."
    if cargo clippy --workspace -- -D warnings 2>&1 | sed 's/^/[clippy] /'; then
        echo "0" > "$CLIPPY_RESULT"
        echo "üìé [clippy] Done"
    else
        echo "1" > "$CLIPPY_RESULT"
        echo "üìé [clippy] Failed"
    fi
) &
CLIPPY_PID=$!

(
    echo "üß™ [test] Starting tests..."
    if cargo test --workspace 2>&1 | sed 's/^/[test] /'; then
        echo "0" > "$TEST_RESULT"
        echo "üß™ [test] Done"
    else
        echo "1" > "$TEST_RESULT"
        echo "üß™ [test] Failed"
    fi
) &
TEST_PID=$!

# Wait for all and collect results
wait $FMT_PID
wait $CLIPPY_PID
wait $TEST_PID

FMT_EXIT=$(cat "$FMT_RESULT")
CLIPPY_EXIT=$(cat "$CLIPPY_RESULT")
TEST_EXIT=$(cat "$TEST_RESULT")

# Cleanup temp files
rm -f "$FMT_RESULT" "$CLIPPY_RESULT" "$TEST_RESULT"

# Report summary
echo ""
echo "========================================"
echo "Summary:"
FAILED=0

if [ "$FMT_EXIT" = "0" ]; then
    echo "  ‚úÖ Format OK"
else
    echo "  ‚ùå Format check failed"
    FAILED=1
fi

if [ "$CLIPPY_EXIT" = "0" ]; then
    echo "  ‚úÖ Clippy OK"
else
    echo "  ‚ùå Clippy check failed"
    FAILED=1
fi

if [ "$TEST_EXIT" = "0" ]; then
    echo "  ‚úÖ Tests OK"
else
    echo "  ‚ùå Tests failed"
    FAILED=1
fi
echo "========================================"

if [ "$FAILED" = "1" ]; then
    echo "üí• Pre-commit checks failed!"
    exit 1
fi

echo "üéâ All pre-commit checks passed!"
